name: Stock Monitor

on:
  schedule:
    # every hour
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      stocks:
        description: 'Comma-separated list of stock symbols to monitor'
        required: false
        default: ''
      default_pct_up:
        description: 'Default percent-up threshold'
        required: false
        default: ''
      default_pct_down:
        description: 'Default percent-down threshold'
        required: false
        default: ''

env:
  DEFAULT_WEBHOOK: ${{ secrets.STOCK_MONITOR_WEBHOOK }}

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ----------------------------
      # Run stock monitor (never fail job)
      # ----------------------------
      - name: Run stock monitor
        id: run_monitor
        env:
          DEFAULT_WEBHOOK: ${{ env.DEFAULT_WEBHOOK }}
          STOCK_LIST: ${{ github.event.inputs.stocks }}
          DEFAULT_PCT_UP: ${{ github.event.inputs.default_pct_up }}
          DEFAULT_PCT_DOWN: ${{ github.event.inputs.default_pct_down }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
        run: |
          python monitor.py || true

      # ----------------------------
      # Prepare alerts output
      # ----------------------------
      - name: Prepare alerts output
      - name: Prepare alerts output
        id: prepare
        run: |
          if [ -f alerts.json ]; then
            python - <<'PY'
            import json
            alerts = json.load(open("alerts.json"))
            with open("alerts.txt", "w", encoding="utf-8") as f:
                f.write("\n\n".join(a.get("text","") for a in alerts))
            PY

            echo "alerts<<EOF" >> $GITHUB_OUTPUT
            cat alerts.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "alerts=" >> $GITHUB_OUTPUT
          fi

      - name: Upload alerts artifact
        if: steps.prepare.outputs.alerts != ''
        uses: actions/upload-artifact@v4
        with:
          name: alerts-json
          path: alerts.json

      # ----------------------------
      # Send Discord embeds (batched safely)
      # ----------------------------
      - name: Send Discord embeds
        if: steps.prepare.outputs.alerts != ''
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL || secrets.STOCK_MONITOR_WEBHOOK }}
        run: |
          python - <<'PY'
          import json, requests

          alerts = json.load(open("alerts.json"))

          def chunks(lst, n):
              for i in range(0, len(lst), n):
                  yield lst[i:i+n]

          embeds = []
          for a in alerts:
              color = 3066993
              if a.get("severity") == "down":
                  color = 15158332

              embeds.append({
                  "title": f"{a.get('symbol')} alert",
                  "description": a.get("text","")[:4000],
                  "color": color
              })

          for batch in chunks(embeds, 10):
              requests.post(
                  "${WEBHOOK}",
                  json={"embeds": batch},
                  timeout=10
              )
          PY
