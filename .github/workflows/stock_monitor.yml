name: Stock Monitor

on:
  schedule:
    - cron: '0 * * * *'   # every hour UTC
  workflow_dispatch:
    inputs:
      stocks:
        description: 'Comma-separated list of stock symbols'
        required: false
        default: ''
      default_pct_up:
        description: 'Default percent-up threshold'
        required: false
        default: ''
      default_pct_down:
        description: 'Default percent-down threshold'
        required: false
        default: ''

env:
  DEFAULT_WEBHOOK: ${{ secrets.STOCK_MONITOR_WEBHOOK }}

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run stock monitor
        env:
          DEFAULT_WEBHOOK: ${{ env.DEFAULT_WEBHOOK }}
          STOCK_LIST: ${{ github.event.inputs.stocks }}
          DEFAULT_PCT_UP: ${{ github.event.inputs.default_pct_up }}
          DEFAULT_PCT_DOWN: ${{ github.event.inputs.default_pct_down }}
        run: |
          python monitor.py

      - name: Prepare alerts output
        id: prepare
        run: |
         if [ -f alerts.json ]; then
           python - <<'PY'
import json
alerts = json.load(open("alerts.json"))
with open("alerts.txt", "w", encoding="utf-8") as f:
    for a in alerts:
        f.write(a.get("text", "") + "\n\n")
PY
          echo "alerts<<EOF" >> "$GITHUB_OUTPUT"
          cat alerts.txt >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
         else
          echo "alerts=" >> "$GITHUB_OUTPUT"

      - name: Upload alerts artifact
        if: steps.prepare.outputs.alerts != ''
        uses: actions/upload-artifact@v4
        with:
          name: alerts-json
          path: alerts.json

      - name: Send Discord embeds
        if: steps.prepare.outputs.alerts != ''
        env:
          WEBHOOK: ${{ secrets.discord_webhook || secrets.STOCK_MONITOR_WEBHOOK }}
        run: |
python - <<'PY'
import json
import os
import requests

webhook = os.environ.get("WEBHOOK")
if not webhook:
    raise RuntimeError("WEBHOOK environment variable not set")

alerts = json.load(open("alerts.json"))

embeds = []
for a in alerts:
    color = 3447003  # blue
    if a.get("severity") == "down":
        color = 15158332  # red
    elif a.get("severity") == "up":
        color = 3066993   # green

    embeds.append({
        "title": f"{a.get('symbol')} alert",
        "description": a.get("text", ""),
        "color": color
    })

payload = {"embeds": embeds[:10]}  # batch max 10 embeds to avoid Discord limits
requests.post(webhook, json=payload, timeout=10)
PY
