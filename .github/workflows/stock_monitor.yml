name: Stock Monitor

on:
  schedule:
    # Run every hour on weekdays
    - cron: '0 13-21 * * 1-5'

  workflow_dispatch:
    inputs:
      stocks:
        description: 'Comma-separated list of stock symbols to monitor'
        required: false
        default: ''
      default_pct_up:
        description: 'Default percent-up threshold to apply to stocks provided via `stocks` input or stocks.txt'
        required: false
        default: ''
      default_pct_down:
        description: 'Default percent-down threshold to apply to stocks provided via `stocks` input or stocks.txt'
        required: false
        default: ''

env:
  DEFAULT_WEBHOOK: ${{ secrets.STOCK_MONITOR_WEBHOOK }}

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run stock monitor
        id: run_monitor
        env:
          DEFAULT_WEBHOOK: ${{ env.DEFAULT_WEBHOOK }}
          STOCK_LIST: ${{ github.event.inputs.stocks }}
          DEFAULT_PCT_UP: ${{ github.event.inputs.default_pct_up }}
          DEFAULT_PCT_DOWN: ${{ github.event.inputs.default_pct_down }}
        run: |
          python monitor.py

      - name: Prepare alerts output
        id: prepare
        run: |
          if [ -f alerts.json ]; then
            # Create a text summary for the GitHub output
            ALERTS_TEXT=$(python -c "import json; alerts=json.load(open('alerts.json')); print('\\n\\n'.join(a.get('text','') for a in alerts))")
            echo "alerts<<EOF" >> $GITHUB_OUTPUT
            echo "$ALERTS_TEXT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "alerts=" >> $GITHUB_OUTPUT
          fi

      - name: Upload alerts artifact
        if: steps.prepare.outputs.alerts != ''
        uses: actions/upload-artifact@v4
        with:
          name: alerts-json
          path: alerts.json

      # - name: Send Discord embeds
      #   if: steps.prepare.outputs.alerts != ''
      #   env:
      #     WEBHOOK: ${{ secrets.discord_webhook || secrets.STOCK_MONITOR_WEBHOOK }}
      #   run: |
      #     python - <<'PY'
      #     import json
      #     alerts = json.load(open('alerts.json'))
      #     embeds = []
      #     for a in alerts:
      #         title = f"{a.get('symbol')} alert"
      #         desc = a.get('text', '')
      #         color = 3066993
      #         if a.get('severity') == 'down':
      #             color = 15158332
      #         elif a.get('severity') == 'up':
      #             color = 3066993
      #         embeds.append({
      #             'title': title,
      #             'description': desc,
      #             'color': color
      #         })
      #     payload = {'embeds': embeds}
      #     print(json.dumps(payload))
      #     open('discord_payload.json', 'w').write(json.dumps(payload))
      #     PY
      #     # post to webhook
      #     curl -s -H "Content-Type: application/json" -d @discord_payload.json "$WEBHOOK" >/dev/null
          
      - name: Send email alerts
        if: steps.prepare.outputs.alerts != ''
        env:
          MAIL_SERVER: ${{ secrets.MAIL_SERVER }}
          MAIL_PORT: ${{ secrets.MAIL_PORT }}
          MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
          ALERT_EMAIL_RECIPIENT: ${{ secrets.ALERT_EMAIL_RECIPIENT }}
        run: |
          python - <<'PY'
          import json, smtplib, os, sys
          from email.message import EmailMessage
          from datetime import datetime
      
          alerts = json.load(open('alerts.json'))
      
          if not alerts:
              print("No alerts to send.")
              sys.exit(0)
      
          recipient = os.environ.get('ALERT_EMAIL_RECIPIENT')
          if not recipient:
              print("ALERT_EMAIL_RECIPIENT not set. Skipping email.")
              sys.exit(0)
      
          server = os.environ.get('MAIL_SERVER')
          port = int(os.environ.get('MAIL_PORT', 587))
          username = os.environ.get('MAIL_USERNAME')
          password = os.environ.get('MAIL_PASSWORD')
      
          if not all([server, port, username, password]):
              print("Email server not configured. Skipping email.")
              sys.exit(0)
      
          timestamp = datetime.utcnow().strftime("%Y-%m-%d %H:%M UTC")
      
          # ---------- Plain text fallback ----------
          text_body = "\n\n".join(a.get('text', '') for a in alerts)
      
          # ---------- HTML body ----------
          rows = []
          for a in alerts:
              severity = a.get('severity', 'neutral')
              color = {
                  'up': '#1f9d55',
                  'down': '#e3342f',
                  'neutral': '#6c757d'
              }.get(severity, '#6c757d')
      
              rows.append(f"""
              <tr>
                <td style="padding:10px;border-left:4px solid {color};">
                  <strong>{a.get('symbol','')}</strong><br/>
                  <span>{a.get('text','')}</span>
                </td>
              </tr>
              """)
      
          html_body = f"""
          <html>
            <body style="font-family:Arial,sans-serif;background:#f7f7f7;padding:20px;">
              <table width="100%" cellpadding="0" cellspacing="0">
                <tr>
                  <td>
                    <h2 style="margin-bottom:5px;">ðŸ“ˆ Stock Market Alerts</h2>
                    <p style="color:#555;margin-top:0;">
                      {len(alerts)} alert(s) triggered â€” {timestamp}
                    </p>
                    <table width="100%" style="background:#ffffff;border-collapse:collapse;">
                      {''.join(rows)}
                    </table>
                    <p style="font-size:12px;color:#999;margin-top:15px;">
                      Sent by GitHub Actions Stock Monitor
                    </p>
                  </td>
                </tr>
              </table>
            </body>
          </html>
          """
      
          msg = EmailMessage()
          msg['Subject'] = f"Stock Market Alerts ({len(alerts)} triggers)"
          msg['From'] = username
          msg['To'] = recipient
      
          msg.set_content(text_body)          # plain text fallback
          msg.add_alternative(html_body, subtype='html')
      
          print(f"Sending HTML aggregated email to {recipient}")
      
          try:
              with smtplib.SMTP(server, port, timeout=30) as s:
                  s.starttls()
                  s.login(username, password)
                  s.send_message(msg)
              print("Aggregated HTML email sent successfully")
          except Exception as e:
              print(f"Failed to send aggregated email: {e}")
              sys.exit(1)
          PY

      - name: Send recap email
        if: steps.run_monitor.outputs.is_market_close == 'true'
        env:
          MAIL_SERVER: ${{ secrets.MAIL_SERVER }}
          MAIL_PORT: ${{ secrets.MAIL_PORT }}
          MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
          ALERT_EMAIL_RECIPIENT: ${{ secrets.ALERT_EMAIL_RECIPIENT }}
        run: |
          python - <<'PY'
          import json, smtplib, os, sys
          from email.message import EmailMessage

          with open('recap.json', 'r') as f:
              recap = json.load(f)

          if not recap:
              print("Recap is empty. Skipping.")
              sys.exit(0)

          recipient = os.environ.get('ALERT_EMAIL_RECIPIENT')
          if not recipient:
              print("ALERT_EMAIL_RECIPIENT not set. Skipping email.")
              sys.exit(0)

          server = os.environ.get('MAIL_SERVER')
          port = int(os.environ.get('MAIL_PORT', 587))
          username = os.environ.get('MAIL_USERNAME')
          password = os.environ.get('MAIL_PASSWORD')

          if not all([server, port, username, password]):
              print("Email server not configured. Skipping email.")
              sys.exit(0)

          title = recap.get('title', 'Market Recap')
          lines = recap.get('lines', [])

          # Read HTML body from recap.html
          with open('recap.html', 'r', encoding='utf-8') as f:
              html_body = f.read()

          msg = EmailMessage()
          msg['Subject'] = title
          msg['From'] = username
          msg['To'] = recipient
          msg.set_content('\n'.join(lines))  # Plain text fallback
          msg.add_alternative(html_body, subtype='html')

          try:
              with smtplib.SMTP(server, port, timeout=30) as s:
                  s.starttls()
                  s.login(username, password)
                  s.send_message(msg)
              print("Recap email sent successfully.")
          except Exception as e:
              print(f"Failed to send recap email: {e}")
              sys.exit(1)
          PY

