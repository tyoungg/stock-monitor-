name: Stock Monitor

on:
  schedule:
    # every hour (adjust cron for desired cadence and timezone)
#   - cron: '0 * * * *'
#   - cron: '*/5 * * * *'  # Every 5 minutes for testing
    - cron: '0 13-20 * * 1-5'  # 9 AM - 4 PM ET (UTC-4/5 depending on DST)
    - cron: '15 20 * * 1-5'    # Market close recap at 4:15 PM ET

  workflow_dispatch:
    inputs:
      stocks:
        description: 'Comma-separated list of stock symbols to monitor'
        required: false
        default: ''
      default_pct_up:
        description: 'Default percent-up threshold to apply to stocks provided via `stocks` input or stocks.txt'
        required: false
        default: ''
      default_pct_down:
        description: 'Default percent-down threshold to apply to stocks provided via `stocks` input or stocks.txt'
        required: false
        default: ''

env:
  DEFAULT_WEBHOOK: ${{ secrets.STOCK_MONITOR_WEBHOOK }}

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run stock monitor
        id: run_monitor
        env:
          DEFAULT_WEBHOOK: ${{ env.DEFAULT_WEBHOOK }}
          STOCK_LIST: ${{ github.event.inputs.stocks }}
          DEFAULT_PCT_UP: ${{ github.event.inputs.default_pct_up }}
          DEFAULT_PCT_DOWN: ${{ github.event.inputs.default_pct_down }}
        run: |
          python monitor.py

      - name: Prepare alerts output
        id: prepare
        run: |
          if [ -f alerts.json ]; then
            # Create a text summary for the GitHub output
            ALERTS_TEXT=$(python -c "import json; alerts=json.load(open('alerts.json')); print('\\n\\n'.join(a.get('text','') for a in alerts))")
            echo "alerts<<EOF" >> $GITHUB_OUTPUT
            echo "$ALERTS_TEXT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "alerts=" >> $GITHUB_OUTPUT
          fi

      - name: Upload alerts artifact
        if: steps.prepare.outputs.alerts != ''
        uses: actions/upload-artifact@v4
        with:
          name: alerts-json
          path: alerts.json

      - name: Send Discord embeds
        if: steps.prepare.outputs.alerts != ''
        env:
          WEBHOOK: ${{ secrets.discord_webhook || secrets.STOCK_MONITOR_WEBHOOK }}
        run: |
          python - <<'PY'
          import json
          alerts = json.load(open('alerts.json'))
          embeds = []
          for a in alerts:
              title = f"{a.get('symbol')} alert"
              desc = a.get('text', '')
              color = 3066993
              if a.get('severity') == 'down':
                  color = 15158332
              elif a.get('severity') == 'up':
                  color = 3066993
              embeds.append({
                  'title': title,
                  'description': desc,
                  'color': color
              })
          payload = {'embeds': embeds}
          print(json.dumps(payload))
          open('discord_payload.json', 'w').write(json.dumps(payload))
          PY
          # post to webhook
          curl -s -H "Content-Type: application/json" -d @discord_payload.json "$WEBHOOK" >/dev/null

      - name: Send email alerts
        if: steps.prepare.outputs.alerts != ''
        env:
          MAIL_SERVER: ${{ secrets.MAIL_SERVER }}
          MAIL_PORT: ${{ secrets.MAIL_PORT }}
          MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
          ALERT_EMAIL_RECIPIENT: ${{ secrets.ALERT_EMAIL_RECIPIENT }}
        run: |
          python - <<'PY'
          import json, smtplib, os, sys
          from email.message import EmailMessage

          alerts = json.load(open('alerts.json'))

          if not alerts:
              print("No alerts to send.")
              sys.exit(0)

          recipient = os.environ.get('ALERT_EMAIL_RECIPIENT')
          if not recipient:
              print("ALERT_EMAIL_RECIPIENT not set. Skipping email.")
              sys.exit(0)

          # Aggregate alerts into one email
          subject = f"Stock Market Alerts ({len(alerts)} triggers)"
          body_lines = [a.get('text', '') for a in alerts]
          body = "\n\n".join(body_lines)

          print(f"Sending aggregated email to {recipient}")

          msg = EmailMessage()
          msg.set_content(body)
          msg['Subject'] = subject
          msg['From'] = os.environ.get('MAIL_USERNAME')
          msg['To'] = recipient

          server = os.environ.get('MAIL_SERVER')
          port = int(os.environ.get('MAIL_PORT', 587))
          username = os.environ.get('MAIL_USERNAME')
          password = os.environ.get('MAIL_PASSWORD')

          if not all([server, port, username, password]):
              print("Email server not configured. Skipping email.")
              sys.exit(0)

          try:
              with smtplib.SMTP(server, port) as s:
                  s.starttls()
                  s.login(username, password)
                  s.send_message(msg)
              print(f"Aggregated email sent to {recipient}")
          except Exception as e:
              print(f"Failed to send aggregated email: {e}")
              sys.exit(1)
          PY
